#!/bin/bash
## taken from https://gist.github.com/s-leroux/7cb7424d33ba3753e907cc2553bcd1ba

if [ $# -eq 0 ]; then
  echo -e "usage: ${0} file [curl_options]
  curl_options can for example be \"-u github_user[:github_token]\""
  exit 1
fi

# 0. Your file name
FNAME="${1}"

# 1. Somehow sanitize the file content
#    Remove \r (from Windows end-of-lines),
#    Replace tabs by \t
#    Replace " by \"
#    Replace EOL by \n
CONTENT=$(sed -e 's/\r//' -e's/\t/\\t/g' -e 's/"/\\"/g' "${FNAME}" | awk '{ printf($0 "\\n") }')

# 2. Build the JSON request
read -r -d '' DESC <<EOF
{
  "description": "some description",
  "public": true,
  "files": {
    "${FNAME}": {
      "content": "${CONTENT}"
    }
  }
}
EOF

# 3.1 Use curl to send a POST request
curl -X POST -d "${DESC}" "https://api.github.com/gists"

## 3.2 Use basic authentication (password is deprecated, API token works)
#curl -u "${GITHUB_USERNAME}" -X POST -d "${DESC}" "https://api.github.com/gists"
